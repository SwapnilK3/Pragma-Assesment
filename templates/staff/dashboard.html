{% extends 'base.html' %}

{% block title %}Staff Dashboard - Pragma E-Commerce{% endblock %}

{% block extra_css %}
<style>
    body { background-color: #f8f9fa; }
    
    /* Sidebar */
    .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 250px;
        background: linear-gradient(180deg, #2c3e50 0%, #1a252f 100%);
        padding-top: 20px;
        z-index: 1000;
        transition: all 0.3s;
    }
    .sidebar .brand {
        color: white;
        font-size: 1.5rem;
        font-weight: bold;
        padding: 0 20px 20px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .sidebar .nav-link {
        color: rgba(255,255,255,0.7);
        padding: 12px 20px;
        border-left: 3px solid transparent;
        transition: all 0.2s;
    }
    .sidebar .nav-link:hover {
        background: rgba(255,255,255,0.1);
        color: white;
    }
    .sidebar .nav-link.active {
        background: rgba(255,255,255,0.1);
        color: white;
        border-left-color: #fd7e14;
    }
    .sidebar .nav-link i { margin-right: 10px; width: 20px; text-align: center; }
    
    /* Main Content */
    .main-content {
        margin-left: 250px;
        padding: 20px;
        min-height: 100vh;
    }
    
    /* Top Bar */
    .top-bar {
        background: white;
        padding: 15px 25px;
        margin: -20px -20px 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    /* Cards */
    .data-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        margin-bottom: 20px;
    }
    .data-card .card-header {
        background: none;
        border-bottom: 1px solid #eee;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .data-card .card-body { padding: 20px; }
    
    /* Tables */
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    .data-table th {
        background: #f8f9fa;
        padding: 12px 15px;
        text-align: left;
        font-weight: 600;
        font-size: 0.85rem;
        color: #6c757d;
        text-transform: uppercase;
        border-bottom: 2px solid #dee2e6;
    }
    .data-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        vertical-align: middle;
    }
    .data-table tr:hover { background: #f8f9fa; }
    .data-table .actions { white-space: nowrap; }
    
    /* Badges */
    .badge-active { background: #198754; }
    .badge-inactive { background: #dc3545; }
    
    /* Forms */
    .form-section { display: none; }
    .form-section.active { display: block; }
    
    /* Filter Bar */
    .filter-bar {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    /* Modal Fixes */
    .modal-lg { max-width: 800px; }
    
    /* Loading */
    .loading-overlay {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(255,255,255,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }
    .empty-state i { font-size: 4rem; margin-bottom: 20px; opacity: 0.3; }
    
    /* Section Toggle */
    .section { display: none; }
    .section.active { display: block; }
    
    /* Quick Stats */
    .stat-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .stat-card .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    .stat-card .stat-value { font-size: 1.75rem; font-weight: bold; }
    .stat-card .stat-label { color: #6c757d; font-size: 0.875rem; }
</style>
{% endblock %}

{% block content %}
<!-- Sidebar -->
<div class="sidebar">
    <div class="brand">
        <i class="bi bi-shop"></i> Pragma Staff
    </div>
    <nav class="nav flex-column mt-3">
        <a class="nav-link active" href="#" data-section="dashboard">
            <i class="bi bi-speedometer2"></i> Dashboard
        </a>
        <a class="nav-link" href="#" data-section="products">
            <i class="bi bi-box-seam"></i> Products
        </a>
        <a class="nav-link" href="#" data-section="categories">
            <i class="bi bi-tags"></i> Categories
        </a>
        <a class="nav-link" href="#" data-section="skus">
            <i class="bi bi-upc-scan"></i> SKUs
        </a>
        <a class="nav-link" href="#" data-section="inventory">
            <i class="bi bi-boxes"></i> Inventory
        </a>
        <a class="nav-link" href="#" data-section="transactions">
            <i class="bi bi-arrow-left-right"></i> Transactions
        </a>
    </nav>
    <div class="mt-auto p-3" style="position: absolute; bottom: 0; width: 100%;">
        <div class="text-white-50 small mb-2">Logged in as:</div>
        <div class="text-white" id="userInfo">Loading...</div>
        <button class="btn btn-outline-light btn-sm mt-2 w-100" onclick="logout()">
            <i class="bi bi-box-arrow-left"></i> Logout
        </button>
    </div>
</div>

<!-- Main Content -->
<div class="main-content">
    <!-- Top Bar -->
    <div class="top-bar">
        <h4 class="mb-0" id="sectionTitle">Dashboard</h4>
        <div id="sectionActions"></div>
    </div>

    <!-- Alert Container -->
    <div id="alert-container"></div>

    <!-- Dashboard Section -->
    <div id="section-dashboard" class="section active">
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-primary bg-opacity-10 text-primary me-3">
                            <i class="bi bi-box-seam"></i>
                        </div>
                        <div>
                            <div class="stat-value" id="stat-products">-</div>
                            <div class="stat-label">Products</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-success bg-opacity-10 text-success me-3">
                            <i class="bi bi-upc-scan"></i>
                        </div>
                        <div>
                            <div class="stat-value" id="stat-skus">-</div>
                            <div class="stat-label">SKUs</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-warning bg-opacity-10 text-warning me-3">
                            <i class="bi bi-boxes"></i>
                        </div>
                        <div>
                            <div class="stat-value" id="stat-inventory">-</div>
                            <div class="stat-label">Stock Items</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-info bg-opacity-10 text-info me-3">
                            <i class="bi bi-tags"></i>
                        </div>
                        <div>
                            <div class="stat-value" id="stat-categories">-</div>
                            <div class="stat-label">Categories</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="data-card">
                    <div class="card-header">
                        <h6 class="mb-0">Recent Products</h6>
                        <a href="#" class="btn btn-sm btn-outline-primary" data-section="products">View All</a>
                    </div>
                    <div class="card-body" id="recent-products">
                        <div class="text-center py-4"><div class="spinner-border spinner-border-sm"></div></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="data-card">
                    <div class="card-header">
                        <h6 class="mb-0">Low Stock Alerts</h6>
                        <a href="#" class="btn btn-sm btn-outline-warning" data-section="inventory">View All</a>
                    </div>
                    <div class="card-body" id="low-stock">
                        <div class="text-center py-4"><div class="spinner-border spinner-border-sm"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Section -->
    <div id="section-products" class="section">
        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="row g-3">
                <div class="col-md-4">
                    <input type="text" class="form-control" id="product-search" placeholder="Search products..." oninput="applyProductFilters()">
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="product-category-filter" onchange="applyProductFilters()">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="product-status-filter" onchange="applyProductFilters()">
                        <option value="">All Status</option>
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
                <div class="col-md-3 text-end">
                    <button class="btn btn-primary" onclick="showProductForm()">
                        <i class="bi bi-plus-lg"></i> Add Product
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Products List -->
        <div class="data-card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="data-table" id="products-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Variants</th>
                                <th>Rating</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="products-tbody">
                            <tr><td colspan="6" class="text-center py-4"><div class="spinner-border spinner-border-sm"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Categories Section -->
    <div id="section-categories" class="section">
        <div class="filter-bar">
            <div class="row g-3">
                <div class="col-md-6">
                    <input type="text" class="form-control" id="category-search" placeholder="Search categories...">
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-primary" onclick="showCategoryForm()">
                        <i class="bi bi-plus-lg"></i> Add Category
                    </button>
                </div>
            </div>
        </div>
        
        <div class="data-card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Parent</th>
                                <th>Products</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="categories-tbody">
                            <tr><td colspan="5" class="text-center py-4"><div class="spinner-border spinner-border-sm"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- SKUs Section -->
    <div id="section-skus" class="section">
        <div class="filter-bar">
            <div class="row g-3">
                <div class="col-md-6">
                    <input type="text" class="form-control" id="sku-search" placeholder="Search SKUs...">
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-primary" onclick="showSKUForm()">
                        <i class="bi bi-plus-lg"></i> Add SKU
                    </button>
                </div>
            </div>
        </div>
        
        <div class="data-card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Short Name</th>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Unit</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="skus-tbody">
                            <tr><td colspan="5" class="text-center py-4"><div class="spinner-border spinner-border-sm"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Section -->
    <div id="section-inventory" class="section">
        <div class="filter-bar">
            <div class="row g-3">
                <div class="col-md-4">
                    <input type="text" class="form-control" id="inventory-search" placeholder="Search inventory...">
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="inventory-stock-filter">
                        <option value="">All Stock Levels</option>
                        <option value="low">Low Stock (&lt; 10)</option>
                        <option value="out">Out of Stock</option>
                        <option value="unlimited">Unlimited</option>
                    </select>
                </div>
                <div class="col-md-5 text-end">
                    <button class="btn btn-primary" onclick="showInventoryForm()">
                        <i class="bi bi-plus-lg"></i> Add Stock Entry
                    </button>
                </div>
            </div>
        </div>
        
        <div class="data-card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Variant</th>
                                <th>Total Qty</th>
                                <th>Reserved</th>
                                <th>Remaining</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-tbody">
                            <tr><td colspan="7" class="text-center py-4"><div class="spinner-border spinner-border-sm"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Transactions Section -->
    <div id="section-transactions" class="section">
        <div class="filter-bar">
            <div class="row g-3">
                <div class="col-md-4">
                    <select class="form-select" id="transaction-type-filter">
                        <option value="">All Types</option>
                        <option value="inward">Inward</option>
                        <option value="outward">Outward</option>
                    </select>
                </div>
                <div class="col-md-8 text-end">
                    <button class="btn btn-success" onclick="showTransactionForm('inward')">
                        <i class="bi bi-arrow-down-circle"></i> Add Inward
                    </button>
                    <button class="btn btn-danger" onclick="showTransactionForm('outward')">
                        <i class="bi bi-arrow-up-circle"></i> Add Outward
                    </button>
                </div>
            </div>
        </div>
        
        <div class="data-card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Inventory</th>
                                <th>Type</th>
                                <th>Quantity</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-tbody">
                            <tr><td colspan="5" class="text-center py-4"><div class="spinner-border spinner-border-sm"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalTitle">Add Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="productForm">
                <div class="modal-body">
                    <input type="hidden" id="product-id">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">Product Name *</label>
                            <input type="text" class="form-control" id="product-name" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Category</label>
                            <div class="input-group">
                                <select class="form-select" id="product-category"></select>
                                <button type="button" class="btn btn-outline-primary" onclick="openQuickCategoryModal()" title="Create New Category">
                                    <i class="bi bi-plus-lg"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="product-description" rows="3"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Rating</label>
                            <input type="number" class="form-control" id="product-rating" step="0.1" min="0" max="5">
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="product-active" checked>
                                <label class="form-check-label" for="product-active">Active</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Variants Section -->
                    <hr class="my-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Product Variants</h6>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addVariantRow()">
                            <i class="bi bi-plus"></i> Add Variant
                        </button>
                    </div>
                    <div id="variants-container"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="productSubmitBtn">
                        <span class="btn-text">Save Product</span>
                        <span class="loading-spinner spinner-border spinner-border-sm" style="display:none"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalTitle">Add Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="categoryForm">
                <div class="modal-body">
                    <input type="hidden" id="category-id">
                    <div class="mb-3">
                        <label class="form-label">Category Name *</label>
                        <input type="text" class="form-control" id="category-name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Parent Category</label>
                        <select class="form-select" id="category-parent">
                            <option value="">None (Top Level)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="category-description" rows="3"></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="category-active" checked>
                        <label class="form-check-label" for="category-active">Active</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Category</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- SKU Modal -->
<div class="modal fade" id="skuModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="skuModalTitle">Add SKU</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="skuForm">
                <div class="modal-body">
                    <input type="hidden" id="sku-id">
                    <div class="mb-3">
                        <label class="form-label">Short Name *</label>
                        <input type="text" class="form-control" id="sku-short-name" required placeholder="e.g., KG, LTR, PCS">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="sku-description" rows="2"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="sku-quantity" value="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Unit</label>
                            <input type="text" class="form-control" id="sku-unit" placeholder="e.g., kg, liters">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save SKU</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Inventory Modal -->
<div class="modal fade" id="inventoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inventoryModalTitle">Add Stock Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="inventoryForm">
                <div class="modal-body">
                    <input type="hidden" id="inventory-id">
                    <input type="hidden" id="inventory-mode" value="create">
                    
                    <!-- Product Selection (for create mode) -->
                    <div id="product-selection-section">
                        <div class="mb-3">
                            <label class="form-label">Product *</label>
                            <select class="form-select" id="inventory-product">
                                <option value="">Select Product</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Variant (Recommended)</label>
                            <select class="form-select" id="inventory-variant">
                                <option value="">Select Variant</option>
                            </select>
                            <small class="text-muted">Select a variant for precise inventory tracking. If no variant, inventory will be tracked at product level.</small>
                        </div>
                    </div>
                    
                    <!-- Product Display (for edit mode) -->
                    <div id="product-display-section" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Product/Variant</label>
                            <input type="text" class="form-control" id="inventory-product-display" readonly>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3" id="initial-qty-section">
                            <label class="form-label" id="qty-label">Initial Quantity</label>
                            <input type="number" class="form-control" id="inventory-initial-qty" value="0" min="0">
                            <small class="text-muted" id="qty-help">Stock to add</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Current Stock</label>
                            <input type="text" class="form-control" id="inventory-current-stock" readonly value="-">
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="inventory-unlimited">
                        <label class="form-check-label" for="inventory-unlimited">Unlimited Stock</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="inventory-submit-btn">Save Stock Entry</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Transaction Modal -->
<div class="modal fade" id="transactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transactionModalTitle">Add Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="transactionForm">
                <div class="modal-body">
                    <input type="hidden" id="transaction-type">
                    <div class="mb-3">
                        <label class="form-label">Inventory *</label>
                        <select class="form-select" id="transaction-inventory" required>
                            <option value="">Select Inventory</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantity *</label>
                        <input type="number" class="form-control" id="transaction-quantity" required min="1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="transaction-notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="transactionSubmitBtn">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Check authentication
if (!TokenManager.isAuthenticated()) {
    window.location.href = URLS.staffLogin;
}

// Verify role
const user = TokenManager.getUser();
if (user && user.role !== 'staff' && user.role !== 'admin') {
    TokenManager.clearTokens();
    window.location.href = URLS.staffLogin;
}

// Display user info
document.getElementById('userInfo').textContent = user ? user.full_name : 'Unknown';

// Data cache
let categories = [];
let products = [];
let skus = [];
let inventories = [];
let variantCounter = 0;

// Navigation
document.querySelectorAll('[data-section]').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        switchSection(this.dataset.section);
    });
});

function switchSection(sectionName, updateUrl = true) {
    // Update nav
    document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
    document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');
    
    // Update sections
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(`section-${sectionName}`).classList.add('active');
    
    // Update title
    const titles = {
        dashboard: 'Dashboard',
        products: 'Products',
        categories: 'Categories',
        skus: 'SKUs',
        inventory: 'Inventory',
        transactions: 'Transactions'
    };
    document.getElementById('sectionTitle').textContent = titles[sectionName];
    
    // Update URL hash
    if (updateUrl) {
        history.pushState(null, '', `#${sectionName}`);
    }
    
    // Load data
    loadSectionData(sectionName);
}

async function loadSectionData(section) {
    switch(section) {
        case 'dashboard': loadDashboard(); break;
        case 'products': loadProducts(); break;
        case 'categories': loadCategories(); break;
        case 'skus': loadSKUs(); break;
        case 'inventory': loadInventory(); break;
        case 'transactions': loadTransactions(); break;
    }
}

// API Helper with Auth
async function apiRequest(endpoint, method = 'GET', data = null, retry = true) {
    const options = {
        method,
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${TokenManager.getAccessToken()}`
        }
    };
    if (data) options.body = JSON.stringify(data);
    
    const response = await fetch(`/api${endpoint}`, options);
    
    // Handle 401 - try token refresh
    if (response.status === 401 && retry) {
        const refreshResult = await tryRefreshToken();
        if (refreshResult === 'refreshed') {
            // Retry the request with new token
            return apiRequest(endpoint, method, data, false);
        } else {
            showSessionExpiredModal();
            throw new Error('Session expired');
        }
    }
    
    return response.json();
}

// Token refresh helper
async function tryRefreshToken() {
    const refreshToken = TokenManager.getRefreshToken();
    if (!refreshToken) return 'expired';
    
    try {
        const response = await fetch('/api/account/token/refresh/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ refresh: refreshToken })
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.access) {
                TokenManager.setTokens(data.access, refreshToken);
                return 'refreshed';
            }
        }
    } catch (e) {
        console.error('Token refresh failed:', e);
    }
    return 'expired';
}

// Show session expired modal (uses modal from base template)
function showSessionExpiredModal() {
    TokenManager.clearTokens();
    const modal = document.getElementById('sessionExpiredModal');
    if (modal) {
        new bootstrap.Modal(modal).show();
    } else {
        alert('Your session has expired. Please log in again.');
        window.location.href = URLS.staffLogin;
    }
}

// Dashboard
async function loadDashboard() {
    try {
        const [prodRes, skuRes, invRes, catRes] = await Promise.all([
            apiRequest('/product/products/'),
            apiRequest('/product/skus/'),
            apiRequest('/inventory/stock/'),
            apiRequest('/product/categories/')
        ]);
        
        const prodCount = prodRes.data?.length || prodRes.results?.length || 0;
        const skuCount = skuRes.data?.length || skuRes.results?.length || 0;
        const invCount = invRes.data?.length || invRes.results?.length || 0;
        const catCount = catRes.data?.length || catRes.results?.length || 0;
        
        document.getElementById('stat-products').textContent = prodCount;
        document.getElementById('stat-skus').textContent = skuCount;
        document.getElementById('stat-inventory').textContent = invCount;
        document.getElementById('stat-categories').textContent = catCount;
        
        // Recent products
        const prods = prodRes.data || prodRes.results || [];
        document.getElementById('recent-products').innerHTML = prods.slice(0, 5).map(p => `
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                <div>
                    <strong>${p.name}</strong>
                    <small class="text-muted d-block">${p.category_name || 'No category'}</small>
                </div>
                <span class="badge ${p.is_active ? 'bg-success' : 'bg-secondary'}">
                    ${p.is_active ? 'Active' : 'Inactive'}
                </span>
            </div>
        `).join('') || '<div class="text-muted">No products yet</div>';
        
        // Low stock
        const invs = invRes.data || invRes.results || [];
        const lowStock = invs.filter(i => !i.is_unlimited_stock && i.remaining_quantity < 10);
        document.getElementById('low-stock').innerHTML = lowStock.slice(0, 5).map(i => `
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                <div>
                    <strong>${i.product_name || 'Unknown'}</strong>
                    <small class="text-muted d-block">${i.variant_name || 'Default'}</small>
                </div>
                <span class="badge bg-warning">${i.remaining_quantity} left</span>
            </div>
        `).join('') || '<div class="text-success"><i class="bi bi-check-circle"></i> All stock levels OK</div>';
        
    } catch(e) {
        console.error('Dashboard error:', e);
    }
}

// Products
async function loadProducts() {
    try {
        // Build query params for filtering
        const search = document.getElementById('product-search').value.trim();
        const category = document.getElementById('product-category-filter').value;
        const statusFilter = document.getElementById('product-status-filter').value;
        
        const params = new URLSearchParams();
        if (search) params.append('search', search);
        if (category) params.append('category', category);
        if (statusFilter) params.append('is_active', statusFilter);
        
        const queryString = params.toString() ? `?${params.toString()}` : '';
        
        const response = await apiRequest(`/product/products/${queryString}`);
        products = response.data || response.results || [];
        
        const tbody = document.getElementById('products-tbody');
        if (products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><i class="bi bi-box-seam"></i><p>No products found</p></td></tr>';
            return;
        }
        
        tbody.innerHTML = products.map(p => `
            <tr>
                <td><strong>${p.name}</strong></td>
                <td>${p.category_name || '<span class="text-muted">-</span>'}</td>
                <td><span class="badge bg-info">${p.variants_count || 0}</span></td>
                <td>${p.rating ? `<i class="bi bi-star-fill text-warning"></i> ${p.rating}` : '-'}</td>
                <td><span class="badge ${p.is_active ? 'badge-active' : 'badge-inactive'}">${p.is_active ? 'Active' : 'Inactive'}</span></td>
                <td class="actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="editProduct('${p.id}')"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${p.id}')"><i class="bi bi-trash"></i></button>
                </td>
            </tr>
        `).join('');
        
        // Load categories for filter
        await loadCategoriesDropdown();
    } catch(e) {
        console.error('Load products error:', e);
    }
}

// Debounced product filter
let productFilterTimeout = null;
function applyProductFilters() {
    if (productFilterTimeout) clearTimeout(productFilterTimeout);
    productFilterTimeout = setTimeout(() => {
        loadProducts();
    }, 300);
}

// Track if categories have been loaded for filters
let categoriesFilterLoaded = false;

async function loadCategoriesDropdown() {
    // Only populate filter dropdown once (categories for product form can be updated)
    if (categories.length === 0) {
        const response = await apiRequest('/product/categories/');
        categories = response.data || response.results || [];
    }
    
    // Only populate filter dropdown once to prevent reset
    if (!categoriesFilterLoaded) {
        const options = '<option value="">All Categories</option>' + 
            categories.map(c => `<option value="${c.id}">${c.name}${c.children_count > 0 ? ` (${c.children_count} sub)` : ''}</option>`).join('');
        document.getElementById('product-category-filter').innerHTML = options;
        categoriesFilterLoaded = true;
    }
    
    // Always update product form category dropdown (needed for new products)
    document.getElementById('product-category').innerHTML = '<option value="">No Category</option>' + 
        categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
}

function showProductForm(product = null) {
    document.getElementById('productModalTitle').textContent = product ? 'Edit Product' : 'Add Product';
    document.getElementById('productForm').reset();
    document.getElementById('product-id').value = product?.id || '';
    document.getElementById('variants-container').innerHTML = '';
    variantCounter = 0;
    
    if (product) {
        document.getElementById('product-name').value = product.name;
        document.getElementById('product-category').value = product.category || '';
        document.getElementById('product-description').value = product.description_plaintext || '';
        document.getElementById('product-rating').value = product.rating || '';
        document.getElementById('product-active').checked = product.is_active;
        
        // Load variants
        if (product.variants) {
            product.variants.forEach(v => addVariantRow(v));
        }
    }
    
    loadCategoriesDropdown();
    loadSKUsDropdown();
    new bootstrap.Modal(document.getElementById('productModal')).show();
}

async function loadSKUsDropdown() {
    if (skus.length === 0) {
        const response = await apiRequest('/product/skus/');
        skus = response.data || response.results || [];
    }
}

async function refreshSKUDropdowns() {
    // Force reload SKUs from server
    const response = await apiRequest('/product/skus/');
    skus = response.data || response.results || [];
    
    // Update all SKU dropdowns in variant rows
    const skuSelects = document.querySelectorAll('#variants-container select[name^="variant-sku-"]');
    skuSelects.forEach(select => {
        const currentValue = select.value;
        const skuOptions = skus.map(s => `<option value="${s.id}">${s.short_name}</option>`).join('');
        select.innerHTML = `<option value="">No SKU</option>${skuOptions}`;
        if (currentValue) {
            select.value = currentValue;
        }
    });
}

function addVariantRow(variant = null) {
    variantCounter++;
    const container = document.getElementById('variants-container');
    const variantSkuId = variant?.product_sku ? String(variant.product_sku) : '';
    const skuOptions = skus.map(s => `<option value="${s.id}" ${variantSkuId === String(s.id) ? 'selected' : ''}>${s.short_name}</option>`).join('');
    
    const row = document.createElement('div');
    row.className = 'variant-row border rounded p-3 mb-2';
    row.id = `variant-row-${variantCounter}`;
    row.innerHTML = `
        <div class="row g-2">
            <div class="col-md-4">
                <input type="text" class="form-control" placeholder="Variant Name" 
                       name="variant-name-${variantCounter}" value="${variant?.name || ''}">
            </div>
            <div class="col-md-3">
                <div class="input-group">
                    <select class="form-select" name="variant-sku-${variantCounter}">
                        <option value="">No SKU</option>
                        ${skuOptions}
                    </select>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="openQuickSKUModal(${variantCounter})" title="Create New SKU">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-3">
                <input type="number" class="form-control" placeholder="Price" step="0.01" 
                       name="variant-price-${variantCounter}" value="${variant?.price || '0'}">
            </div>
            <div class="col-md-2 text-end">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeVariantRow(${variantCounter})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
        <input type="hidden" name="variant-id-${variantCounter}" value="${variant?.id || ''}">
    `;
    container.appendChild(row);
}

function removeVariantRow(id) {
    document.getElementById(`variant-row-${id}`).remove();
}

document.getElementById('productForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const productId = document.getElementById('product-id').value;
    const data = {
        name: document.getElementById('product-name').value,
        category: document.getElementById('product-category').value || null,
        description_plaintext: document.getElementById('product-description').value,
        rating: document.getElementById('product-rating').value || null,
        is_active: document.getElementById('product-active').checked
    };
    
    try {
        let response;
        if (productId) {
            response = await apiRequest(`/product/products/${productId}/`, 'PATCH', data);
        } else {
            response = await apiRequest('/product/products/', 'POST', data);
        }
        
        if (response.success !== false && (response.id || response.data?.id)) {
            const newProductId = response.id || response.data?.id;
            
            // Handle variants
            const variantRows = document.querySelectorAll('.variant-row');
            for (const row of variantRows) {
                const rowId = row.id.split('-')[2];
                const variantId = document.querySelector(`[name="variant-id-${rowId}"]`).value;
                const variantData = {
                    product: newProductId,
                    name: document.querySelector(`[name="variant-name-${rowId}"]`).value,
                    product_sku: document.querySelector(`[name="variant-sku-${rowId}"]`).value || null,
                    price: document.querySelector(`[name="variant-price-${rowId}"]`).value || 0
                };
                
                if (variantId) {
                    await apiRequest(`/product/variants/${variantId}/`, 'PATCH', variantData);
                } else if (variantData.name) {
                    await apiRequest('/product/variants/', 'POST', variantData);
                }
            }
            
            bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
            showAlert(document.getElementById('alert-container'), 'Product saved successfully!', 'success');
            loadProducts();
        } else {
            showAlert(document.getElementById('alert-container'), response.message || 'Failed to save product');
        }
    } catch(e) {
        console.error('Save product error:', e);
        showAlert(document.getElementById('alert-container'), 'Error saving product');
    }
});

async function editProduct(id) {
    const response = await apiRequest(`/product/products/${id}/`);
    const product = response.data || response;
    await loadSKUsDropdown();
    showProductForm(product);
}

async function deleteProduct(id) {
    if (!confirm('Are you sure you want to delete this product?')) return;
    
    try {
        await apiRequest(`/product/products/${id}/`, 'DELETE');
        showAlert(document.getElementById('alert-container'), 'Product deleted', 'success');
        loadProducts();
    } catch(e) {
        showAlert(document.getElementById('alert-container'), 'Error deleting product');
    }
}

// Categories
async function loadCategories() {
    try {
        const response = await apiRequest('/product/categories/');
        categories = response.data || response.results || [];
        
        const tbody = document.getElementById('categories-tbody');
        if (categories.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><i class="bi bi-tags"></i><p>No categories found</p></td></tr>';
            return;
        }
        
        tbody.innerHTML = categories.map(c => `
            <tr>
                <td><strong>${c.name}</strong></td>
                <td>${c.parent ? categories.find(p => p.id === c.parent)?.name || '-' : '<span class="text-muted">Top Level</span>'}</td>
                <td>-</td>
                <td><span class="badge ${c.is_active ? 'badge-active' : 'badge-inactive'}">${c.is_active ? 'Active' : 'Inactive'}</span></td>
                <td class="actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="editCategory('${c.id}')"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory('${c.id}')"><i class="bi bi-trash"></i></button>
                </td>
            </tr>
        `).join('');
    } catch(e) {
        console.error('Load categories error:', e);
    }
}

function showCategoryForm(category = null) {
    document.getElementById('categoryModalTitle').textContent = category ? 'Edit Category' : 'Add Category';
    document.getElementById('categoryForm').reset();
    document.getElementById('category-id').value = category?.id || '';
    
    // Parent dropdown
    const parentOptions = '<option value="">None (Top Level)</option>' + 
        categories.filter(c => c.id !== category?.id).map(c => 
            `<option value="${c.id}" ${category?.parent === c.id ? 'selected' : ''}>${c.name}</option>`
        ).join('');
    document.getElementById('category-parent').innerHTML = parentOptions;
    
    if (category) {
        document.getElementById('category-name').value = category.name;
        document.getElementById('category-description').value = category.description_plaintext || '';
        document.getElementById('category-active').checked = category.is_active;
    }
    
    new bootstrap.Modal(document.getElementById('categoryModal')).show();
}

// Quick Create functions for omnichannel workflow
let quickCreateCallback = null;
let quickCreateVariantRow = null;

function openQuickCategoryModal() {
    // Store state that we're in quick create mode from product form
    quickCreateCallback = 'category';
    showCategoryForm(null);
}

function openQuickSKUModal(variantRowId) {
    // Store state that we're in quick create mode from variant row
    quickCreateCallback = 'sku';
    quickCreateVariantRow = variantRowId;
    showSKUForm(null);
}

document.getElementById('categoryForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const categoryId = document.getElementById('category-id').value;
    const data = {
        name: document.getElementById('category-name').value,
        parent: document.getElementById('category-parent').value || null,
        description_plaintext: document.getElementById('category-description').value,
        is_active: document.getElementById('category-active').checked
    };
    
    try {
        let response;
        if (categoryId) {
            response = await apiRequest(`/product/categories/${categoryId}/`, 'PATCH', data);
        } else {
            response = await apiRequest('/product/categories/', 'POST', data);
        }
        
        bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
        
        // Refresh categories list
        categories = [];
        await loadCategoriesDropdown();
        loadCategories();
        
        // If quick create, select the new category
        if (quickCreateCallback === 'category' && response.data) {
            document.getElementById('product-category').value = response.data.id;
            showAlert(document.getElementById('alert-container'), 'Category created and selected!', 'success');
        } else {
            showAlert(document.getElementById('alert-container'), 'Category saved!', 'success');
        }
        quickCreateCallback = null;
    } catch(e) {
        const errorMsg = e.message || 'Error saving category';
        showAlert(document.getElementById('alert-container'), errorMsg, 'danger');
    }
});

async function editCategory(id) {
    const cat = categories.find(c => c.id === id);
    showCategoryForm(cat);
}

async function deleteCategory(id) {
    if (!confirm('Are you sure?')) return;
    await apiRequest(`/product/categories/${id}/`, 'DELETE');
    loadCategories();
}

// SKUs
async function loadSKUs() {
    try {
        const response = await apiRequest('/product/skus/');
        skus = response.data || response.results || [];
        
        const tbody = document.getElementById('skus-tbody');
        if (skus.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><i class="bi bi-upc-scan"></i><p>No SKUs found</p></td></tr>';
            return;
        }
        
        tbody.innerHTML = skus.map(s => `
            <tr>
                <td><strong>${s.short_name}</strong></td>
                <td>${s.description || '<span class="text-muted">-</span>'}</td>
                <td>${s.quantity}</td>
                <td>${s.unit || '<span class="text-muted">-</span>'}</td>
                <td class="actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="editSKU('${s.id}')"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSKU('${s.id}')"><i class="bi bi-trash"></i></button>
                </td>
            </tr>
        `).join('');
    } catch(e) {
        console.error('Load SKUs error:', e);
    }
}

function showSKUForm(sku = null) {
    document.getElementById('skuModalTitle').textContent = sku ? 'Edit SKU' : 'Add SKU';
    document.getElementById('skuForm').reset();
    document.getElementById('sku-id').value = sku?.id || '';
    
    if (sku) {
        document.getElementById('sku-short-name').value = sku.short_name;
        document.getElementById('sku-description').value = sku.description || '';
        document.getElementById('sku-quantity').value = sku.quantity;
        document.getElementById('sku-unit').value = sku.unit || '';
    }
    
    new bootstrap.Modal(document.getElementById('skuModal')).show();
}

document.getElementById('skuForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const skuId = document.getElementById('sku-id').value;
    const data = {
        short_name: document.getElementById('sku-short-name').value,
        description: document.getElementById('sku-description').value,
        quantity: parseInt(document.getElementById('sku-quantity').value) || 0,
        unit: document.getElementById('sku-unit').value
    };
    
    try {
        let newSKU = null;
        if (skuId) {
            await apiRequest(`/product/skus/${skuId}/`, 'PATCH', data);
        } else {
            const response = await apiRequest('/product/skus/', 'POST', data);
            newSKU = response;
        }
        
        bootstrap.Modal.getInstance(document.getElementById('skuModal')).hide();
        showAlert(document.getElementById('alert-container'), 'SKU saved!', 'success');
        
        // Handle quick create callback for omnichannel workflow
        if (quickCreateCallback === 'sku' && newSKU && quickCreateVariantRow) {
            // Reload SKUs and select new one in the variant row
            await loadSKUs();
            // Update all SKU dropdowns with new options
            await refreshSKUDropdowns();
            const variantNum = quickCreateVariantRow.replace('variant-row-', '');
            const skuSelect = document.querySelector(`select[name="variant-sku-${variantNum}"]`);
            if (skuSelect && newSKU.id) {
                skuSelect.value = newSKU.id;
            }
            quickCreateCallback = null;
            quickCreateVariantRow = null;
            // Re-show product modal
            new bootstrap.Modal(document.getElementById('productModal')).show();
        } else {
            loadSKUs();
        }
    } catch(e) {
        showAlert(document.getElementById('alert-container'), 'Error saving SKU');
    }
});

function editSKU(id) {
    const sku = skus.find(s => s.id === id);
    showSKUForm(sku);
}

async function deleteSKU(id) {
    if (!confirm('Are you sure?')) return;
    await apiRequest(`/product/skus/${id}/`, 'DELETE');
    loadSKUs();
}

// Inventory
async function loadInventory() {
    try {
        const response = await apiRequest('/inventory/stock/');
        inventories = response.data || response.results || [];
        
        const tbody = document.getElementById('inventory-tbody');
        if (inventories.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><i class="bi bi-boxes"></i><p>No inventory entries</p></td></tr>';
            return;
        }
        
        tbody.innerHTML = inventories.map(i => {
            let statusBadge = 'bg-success';
            let statusText = 'In Stock';
            if (i.is_unlimited_stock) {
                statusBadge = 'bg-info';
                statusText = 'Unlimited';
            } else if (i.remaining_quantity === 0) {
                statusBadge = 'bg-danger';
                statusText = 'Out of Stock';
            } else if (i.remaining_quantity < 10) {
                statusBadge = 'bg-warning';
                statusText = 'Low Stock';
            }
            
            return `
                <tr>
                    <td><strong>${i.product_name || 'Unknown'}</strong></td>
                    <td>${i.variant_name || '<span class="text-muted">-</span>'}</td>
                    <td>${i.total_quantity}</td>
                    <td>${i.reserved_quantity}</td>
                    <td>${i.remaining_quantity}</td>
                    <td><span class="badge ${statusBadge}">${statusText}</span></td>
                    <td class="actions">
                        <button class="btn btn-sm btn-outline-success" onclick="quickInward('${i.id}')" title="Add Stock">
                            <i class="bi bi-plus-circle"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="editInventory('${i.id}')"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteInventory('${i.id}')"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
            `;
        }).join('');
    } catch(e) {
        console.error('Load inventory error:', e);
    }
}

async function showInventoryForm(inventory = null) {
    const isEdit = !!inventory;
    document.getElementById('inventoryModalTitle').textContent = isEdit ? 'Edit Stock Entry' : 'Add Stock Entry';
    document.getElementById('inventoryForm').reset();
    document.getElementById('inventory-id').value = inventory?.id || '';
    document.getElementById('inventory-mode').value = isEdit ? 'edit' : 'create';
    
    // Toggle sections based on mode
    document.getElementById('product-selection-section').style.display = isEdit ? 'none' : 'block';
    document.getElementById('product-display-section').style.display = isEdit ? 'block' : 'none';
    
    // Update labels for edit mode
    if (isEdit) {
        document.getElementById('qty-label').textContent = 'Add Stock';
        document.getElementById('qty-help').textContent = 'Enter quantity to add to current stock';
        document.getElementById('inventory-submit-btn').textContent = 'Add Stock';
        document.getElementById('inventory-product-display').value = inventory.variant_name || inventory.product_name || 'Unknown';
        document.getElementById('inventory-current-stock').value = `${inventory.remaining_quantity} available (${inventory.total_quantity} total, ${inventory.reserved_quantity} reserved)`;
        document.getElementById('inventory-unlimited').checked = inventory.is_unlimited_stock;
    } else {
        document.getElementById('qty-label').textContent = 'Initial Quantity';
        document.getElementById('qty-help').textContent = 'Initial stock quantity';
        document.getElementById('inventory-submit-btn').textContent = 'Save Stock Entry';
        document.getElementById('inventory-current-stock').value = '-';
        
        // Load products
        if (products.length === 0) {
            const resp = await apiRequest('/product/products/');
            products = resp.data || resp.results || [];
        }
        
        document.getElementById('inventory-product').innerHTML = '<option value="">Select Product</option>' +
            products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        document.getElementById('inventory-variant').innerHTML = '<option value="">Select Variant</option>';
    }
    
    new bootstrap.Modal(document.getElementById('inventoryModal')).show();
}

// Load variants when product changes
document.getElementById('inventory-product').addEventListener('change', async function() {
    const productId = this.value;
    if (!productId) {
        document.getElementById('inventory-variant').innerHTML = '<option value="">Select Variant</option>';
        return;
    }
    
    const response = await apiRequest(`/product/products/${productId}/`);
    const product = response.data || response;
    const variants = product.variants || [];
    
    document.getElementById('inventory-variant').innerHTML = '<option value="">No Variant</option>' +
        variants.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
});

document.getElementById('inventoryForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const inventoryId = document.getElementById('inventory-id').value;
    const mode = document.getElementById('inventory-mode').value;
    const quantity = parseInt(document.getElementById('inventory-initial-qty').value) || 0;
    const isUnlimited = document.getElementById('inventory-unlimited').checked;
    
    let data = {};
    let url = '/inventory/stock/';
    let method = 'POST';
    
    if (mode === 'edit' && inventoryId) {
        // Edit mode - add stock to existing inventory
        url = `/inventory/stock/${inventoryId}/`;
        method = 'PATCH';
        data = {
            is_unlimited_stock: isUnlimited
        };
        if (quantity > 0) {
            data.add_stock = quantity;
        }
    } else {
        // Create mode - new inventory entry
        const productId = document.getElementById('inventory-product').value;
        const variantId = document.getElementById('inventory-variant').value;
        
        if (!productId && !variantId) {
            showAlert(document.getElementById('alert-container'), 'Please select a product or variant', 'danger');
            return;
        }
        
        // Prefer variant if selected, otherwise use product
        if (variantId) {
            data.product_variant = variantId;
        } else {
            data.product = productId;
        }
        
        data.initial_quantity = quantity;
        data.is_unlimited_stock = isUnlimited;
    }
    
    try {
        await apiRequest(url, method, data);
        bootstrap.Modal.getInstance(document.getElementById('inventoryModal')).hide();
        showAlert(document.getElementById('alert-container'), mode === 'edit' ? 'Stock updated!' : 'Stock entry created!', 'success');
        loadInventory();
    } catch(e) {
        console.error('Inventory save error:', e);
        const errorMsg = e.message || 'Error saving stock entry';
        showAlert(document.getElementById('alert-container'), errorMsg, 'danger');
    }
});

function editInventory(id) {
    const inv = inventories.find(i => i.id === id);
    showInventoryForm(inv);
}

async function deleteInventory(id) {
    if (!confirm('Are you sure?')) return;
    await apiRequest(`/inventory/stock/${id}/`, 'DELETE');
    loadInventory();
}

function quickInward(inventoryId) {
    // Reset form first, then set values
    document.getElementById('transactionForm').reset();
    document.getElementById('transaction-type').value = 'inward';
    document.getElementById('transactionModalTitle').textContent = 'Add Inward Stock';
    document.getElementById('transactionSubmitBtn').className = 'btn btn-success';
    document.getElementById('transactionSubmitBtn').textContent = 'Add Stock';
    
    // Find the inventory to show its name
    const inv = inventories.find(i => i.id === inventoryId);
    const invName = inv ? `${inv.product_name || 'Unknown'}${inv.variant_name ? ' - ' + inv.variant_name : ''}` : 'Selected Inventory';
    
    document.getElementById('transaction-inventory').innerHTML = 
        `<option value="${inventoryId}" selected>${invName}</option>`;
    
    new bootstrap.Modal(document.getElementById('transactionModal')).show();
}

// Transactions
async function loadTransactions() {
    try {
        const response = await apiRequest('/inventory/transactions/');
        const transactions = response.data || response.results || [];
        
        // Load inventories for dropdown
        if (inventories.length === 0) {
            const invResp = await apiRequest('/inventory/stock/');
            inventories = invResp.data || invResp.results || [];
        }
        
        const tbody = document.getElementById('transactions-tbody');
        if (transactions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><i class="bi bi-arrow-left-right"></i><p>No transactions</p></td></tr>';
            return;
        }
        
        tbody.innerHTML = transactions.map(t => `
            <tr>
                <td>${new Date(t.created_at).toLocaleString()}</td>
                <td>${inventories.find(i => i.id === t.inventory)?.product_name || 'Unknown'}</td>
                <td>
                    <span class="badge ${t.type === 'inward' ? 'bg-success' : 'bg-danger'}">
                        <i class="bi bi-arrow-${t.type === 'inward' ? 'down' : 'up'}-circle"></i> 
                        ${t.type_display || t.type}
                    </span>
                </td>
                <td><strong>${t.quantity}</strong></td>
                <td class="actions">
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction('${t.id}')"><i class="bi bi-trash"></i></button>
                </td>
            </tr>
        `).join('');
    } catch(e) {
        console.error('Load transactions error:', e);
    }
}

async function showTransactionForm(type) {
    // Reset form first, then set values
    document.getElementById('transactionForm').reset();
    document.getElementById('transaction-type').value = type;
    document.getElementById('transactionModalTitle').textContent = type === 'inward' ? 'Add Inward Stock' : 'Remove Stock (Outward)';
    document.getElementById('transactionSubmitBtn').className = type === 'inward' ? 'btn btn-success' : 'btn btn-danger';
    document.getElementById('transactionSubmitBtn').textContent = type === 'inward' ? 'Add Stock' : 'Remove Stock';
    
    // Load inventories
    if (inventories.length === 0) {
        const resp = await apiRequest('/inventory/stock/');
        inventories = resp.data || resp.results || [];
    }
    
    document.getElementById('transaction-inventory').innerHTML = '<option value="">Select Inventory</option>' +
        inventories.map(i => `<option value="${i.id}">${i.product_name || 'Unknown'} ${i.variant_name ? '- ' + i.variant_name : ''}</option>`).join('');
    
    new bootstrap.Modal(document.getElementById('transactionModal')).show();
}

document.getElementById('transactionForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const inventoryId = document.getElementById('transaction-inventory').value;
    const transactionType = document.getElementById('transaction-type').value;
    const quantity = parseInt(document.getElementById('transaction-quantity').value);
    const notes = document.getElementById('transaction-notes').value;
    
    if (!inventoryId) {
        showAlert(document.getElementById('alert-container'), 'Please select an inventory', 'danger');
        return;
    }
    
    if (!quantity || quantity < 1) {
        showAlert(document.getElementById('alert-container'), 'Please enter a valid quantity', 'danger');
        return;
    }
    
    const data = {
        inventory: inventoryId,
        type: transactionType || 'inward',
        quantity: quantity,
        metadata: { notes: notes || '' }
    };
    
    console.log('Submitting transaction:', data);
    
    try {
        const response = await apiRequest('/inventory/transactions/', 'POST', data);
        console.log('Transaction response:', response);
        bootstrap.Modal.getInstance(document.getElementById('transactionModal')).hide();
        showAlert(document.getElementById('alert-container'), 'Transaction recorded successfully!', 'success');
        loadTransactions();
        loadInventory();
    } catch(e) {
        console.error('Transaction error:', e);
        const errorMsg = e.message || 'Error recording transaction';
        showAlert(document.getElementById('alert-container'), errorMsg, 'danger');
    }
});

async function deleteTransaction(id) {
    if (!confirm('Are you sure?')) return;
    await apiRequest(`/inventory/transactions/${id}/`, 'DELETE');
    loadTransactions();
}

// Logout
function logout() {
    TokenManager.clearTokens();
    window.location.href = URLS.staffLogin;
}

// Handle browser back/forward navigation
window.addEventListener('popstate', function() {
    const hash = window.location.hash.replace('#', '');
    if (hash && document.querySelector(`[data-section="${hash}"]`)) {
        switchSection(hash, false);
    }
});

// Initial load - check for hash in URL
const initialHash = window.location.hash.replace('#', '');
const validSections = ['dashboard', 'products', 'categories', 'skus', 'inventory', 'transactions'];
if (initialHash && validSections.includes(initialHash)) {
    switchSection(initialHash, false);
} else {
    loadDashboard();
}
</script>
{% endblock %}
